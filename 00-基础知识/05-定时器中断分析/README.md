# 简介
这里就不扯有的没的了,英文简称含义等等基础信息,可以去看上一章节定时器中断分析的内容.

- [原理](#原理)
- [运行逻辑](#运行逻辑)
- [变形](#变形)
    - [PWM](#PWM)

## 原理
- 定时器的定时,无法离开系统时钟信号.系统时钟,发射的是方波,数字信号的一种(可以理解为传送`0`或`1`的一种信号),时钟信号每进行一次脉冲,计数器就会`+1`.
- 但是存在一个问题.`ST`的`MCU`,计数器最大值为`2^16`,也就是`65536`,那么如果直接按照系统频率的话,计完`65536`次,只需要`0.9ms`(`2^16 * 1/f`, 其中`f=72HMZ`),太快了.
- 所以需要有个分频器`psc`.`psc`的作用是什么呢?主时钟滴答的太快了,`psc`每过`N`次让计数器动一次.具体解释如下.
- 比如`psc`取值为`7199`,那么计数时的实际频率为`f_计数 = f/(psc+1) = 10KHZ`,这样的话,计数寄存器每隔`0.1ms`才计数一次.
- 所谓的计数寄存器,就是用`CNT`来表示.那么还有个寄存器`ARR`是干什么的呢?一方面用来给`CNT`溢出清零的,另一方面则是有着使能该计数器中断的用处.
- 还有一个`per`,可以视为`ARR`寄存器的最大值,当达到该值后,`ARR`寄存器就会清零`CNT`.
- 所以中断发生时间,其实就是`T=(ARR+1)/f_计数`,如果`psc=7199,ARR(或per)=9999`,那么`T=1s`.

## 运行逻辑
`CNT`收到分频后的时钟脉冲后,会`+1`->达到`ARR`后,`CNT`清零,并置位`UIF`(在`TIMx_SR`寄存器中)->若`TIMx_DIER`的`UIE=1`(中断使能)->向`NVIC`发送中断请求信号.

## 变形
这里就举一个定时器中的例子,更好地理解.

### PWM
- `PWM`也很有意思.里面蕴含了微积分的思想.
- `PWM`这里开始追求平均电压了.可是之前,我们所有的判断,几乎都是逻辑判断,没有占空比,是高电平就是高电平,低电平就是低电平.每当嗅到了高电平信息,我就产生高电平逻辑.低电平也是如此.那么`PWM`为什么追求平均电压呢?
- `PWM`是一个信号源,产生能量,驱动`LED`,电机等的运作.
- 之前,我们要么打开`LED`,要么关闭`LED`.打开`LED`就是像其输出高电平,一直开着的话,其高电平就一直是`3.3v`,平均电压其实也是`3.3v`.
- `PWM`是我们抽象模拟的正弦波.该正弦波则是由系统时钟的方波信号不同的高电平占空比抽象模拟出来的.所以,对于该正弦波而言,我们分析的是其平均电压.
- `PWM`的一个周期是固定不变的.变化的是高电平的占空比.占领`100%`,平均电压为`3.3v`,占领`75%`,平均电压则是`3/4*3.3v`.
- 其实就是微积分,所谓的占空比,不就是正弦波图像与`x`轴围成的面积吗(某段时间内的)?
- 既然如此,方波可以抽象模拟正弦波,那具体如何实现呢?也很简单.我们有一个比较寄存器(`CCR`),占空比就是`CCR/ARR`.如果`CNT>CCR`,输出高电平,`CNT<CCR`则输出低电平.当然,也可能会反过来,需要看具体配置.
- 可能还是看不懂,那就说得再详细一些.`CNT`是计数寄存器,没当达到`ARR`时会清零.现在,我们增添了一个新的寄存器`CCR`,可以使得某信号通道产生信号.产生信号的逻辑是:在`CNT`从零增加的过程中,如果`CNT>CCR`,该通道产生高电平.如果`CNT<CCR`则产生低电平.
- 此时周期一定(`ARR`不变),占空比由`CCR`控制.这样,我们就可以通过平均电压,来抽象表示正弦波信号.
- 太神奇了,正常情况下,我们是根据某函数图像,用微积分手段解决各种问题,但在这里,我们用反微积分思想,通过面积(占空比),来反向抽象某函数.
