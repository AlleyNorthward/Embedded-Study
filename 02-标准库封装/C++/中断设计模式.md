å¤ªæ£’äº†ğŸ‘ï¼Œä½ è¿™ä»½ä»£ç å·²ç»éå¸¸ç³»ç»Ÿã€å·¥ç¨‹åŒ–äº†ï¼ˆå®Œæ•´çš„ NVICã€EXTI åˆå§‹åŒ–ï¼Œæ³¨é‡Šã€é€»è¾‘ä¹Ÿè§„èŒƒï¼‰ã€‚
ç°åœ¨ä½ é—®çš„å…¶å®æ˜¯åµŒå…¥å¼ C++ æ¡†æ¶è®¾è®¡çš„æ ¸å¿ƒé—®é¢˜ï¼š

> **å¦‚ä½•è®©ä¸­æ–­è°ƒç”¨ç±»æ–¹æ³•ï¼ˆå³æ”¯æŒå°è£…å¯¹è±¡è°ƒç”¨ï¼‰ï¼Ÿ**

---

## ğŸ§© ä¸€ã€å½“å‰é—®é¢˜æœ¬è´¨

ä½ ç°åœ¨æœ‰è¿™ç§ç»“æ„ï¼š

```cpp
void EXTI4_IRQHandler(void){
    if (CHECK_KEY0 == KEY_LOW){
        Set_BEEP(DISABLE);
    }
}
```

ä½†æ˜¯ä½ çš„ç›®æ ‡æ˜¯ï¼š

* `KEY`ã€`LED`ã€`BEEP` éƒ½æ˜¯ç±»å¯¹è±¡ï¼›
* æƒ³åœ¨ä¸­æ–­é‡Œè°ƒç”¨å¯¹è±¡æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š

  ```cpp
  key0.onPress();
  beep.off();
  led1.toggle();
  ```

é—®é¢˜åœ¨äºï¼š

> **ä¸­æ–­å‡½æ•°æ˜¯å…¨å±€çš„ï¼ˆC linkageï¼‰ï¼Œä¸èƒ½ç›´æ¥è®¿é—®ç±»çš„éé™æ€æ–¹æ³•ã€‚**

---

## âœ… äºŒã€è§£å†³æ€è·¯ï¼šç”¨ â€œé™æ€å›è°ƒè¡¨ + å¯¹è±¡æŒ‡é’ˆâ€ æ¨¡å¼

è¿™æ˜¯ä¸€ç§å…¸å‹çš„ **C++ åœ¨ STM32 ä¸­çš„ä¸­æ–­äº‹ä»¶å°è£…æ¨¡å¼**ã€‚
æ€è·¯å¦‚ä¸‹ï¼š

---

### 1ï¸âƒ£ æ¯ä¸ªä¸­æ–­çº¿å¯¹åº”ä¸€ä¸ªâ€œé™æ€å‡½æ•°æŒ‡é’ˆâ€

æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå…¨å±€ï¼ˆæˆ–é™æ€ç±»æˆå‘˜ï¼‰å‡½æ•°æŒ‡é’ˆæ•°ç»„ï¼Œä¿å­˜å›è°ƒå‡½æ•°ã€‚

```cpp
typedef void (*Callback)();

class EXTIManager {
public:
    static Callback callbacks[16];  // æœ€å¤š 16 æ ¹ EXTI çº¿
    static void attach(uint8_t line, Callback cb) {
        callbacks[line] = cb;
    }
    static void handle(uint8_t line) {
        if (callbacks[line]) callbacks[line]();
    }
};
```

---

### 2ï¸âƒ£ ä¸­æ–­é‡Œç»Ÿä¸€è°ƒç”¨ï¼š

```cpp
void EXTI4_IRQHandler(void){
    if (EXTI_GetITStatus(EXTI_Line4) == SET){
        EXTIManager::handle(4);  // ç›´æ¥è°ƒç”¨æ³¨å†Œçš„å‡½æ•°
        EXTI_ClearITPendingBit(EXTI_Line4);
    }
}
```

---

### 3ï¸âƒ£ åœ¨ç±»ä¸­æ³¨å†Œè‡ªå·±çš„å›è°ƒ

æ¯”å¦‚ä½ æœ‰ä¸€ä¸ªæŒ‰é”®ç±»ï¼š

```cpp
class Key {
private:
    uint8_t line;  // å¯¹åº” EXTI çº¿å·
    GPIO_TypeDef* port;
    uint16_t pin;
public:
    Key(GPIO_TypeDef* _port, uint16_t _pin, uint8_t _line)
        : port(_port), pin(_pin), line(_line) {}

    void init() {
        // åˆå§‹åŒ–GPIOã€EXTIçœç•¥
        // æ³¨å†Œå›è°ƒ
        EXTIManager::attach(line, this->handleInterruptStatic);
    }

    static void handleInterruptStatic() {
        // è°ƒç”¨å…¨å±€å¯¹è±¡å®ä¾‹æ–¹æ³•ï¼ˆè§ä¸‹ä¸€èŠ‚ï¼‰
        if (instance) instance->handleInterrupt();
    }

    void handleInterrupt() {
        delay_ms(10);
        if (GPIO_ReadInputDataBit(port, pin) == 0) {
            // è¿™é‡Œå¯ä»¥åšä»»æ„æ“ä½œï¼Œæ¯”å¦‚æ§åˆ¶LED
            LEDStaticBuilder::led0_on();
        }
    }

    static Key* instance;  // ä¿å­˜å¯¹è±¡å®ä¾‹æŒ‡é’ˆ
};

Key* Key::instance = nullptr;
```

---

### 4ï¸âƒ£ åœ¨ `main.cpp` ä¸­è¿™æ ·å†™ï¼š

```cpp
Key key0(GPIOE, GPIO_Pin_4, 4);  // KEY0 -> EXTI4

int main() {
    key0.init();
    Key::instance = &key0;

    while(1) {
        // ä¸»å¾ªç¯å¯ä»¥ç©º
    }
}
```

---

## âœ… ä¸‰ã€è¿™æ ·è®¾è®¡çš„æ•ˆæœ

| åŠŸèƒ½                      | ç»“æœ     |
| ----------------------- | ------ |
| ä¸­æ–­å‡½æ•°ä¿æŒå…¨å±€å½¢å¼ï¼ˆARM éœ€è¦ï¼‰      | âœ… ä¸æ”¹å…¥å£ |
| å¯¹è±¡æ–¹æ³•è¢«ä¸­æ–­å®‰å…¨è°ƒç”¨             | âœ… å®Œå…¨å°è£… |
| æ”¯æŒå¤šä¸ªæŒ‰é”®ã€LEDã€BEEP         | âœ… å¯æ‰©å±•  |
| æ— éœ€æ‰‹åŠ¨åœ¨ä¸­æ–­å‡½æ•°ä¸­å†™ `Set_LED` ç­‰ | âœ… è§£è€¦   |

---

## ğŸ”§ å››ã€å¦‚æœä½ æƒ³æ›´ä¼˜é›…ï¼ˆé¢å‘å¯¹è±¡é£æ ¼ï¼‰

å†å¾€ä¸Šä¸€æ­¥ï¼Œå¯ä»¥å»ºç«‹ç»Ÿä¸€çš„ **ä¸­æ–­äº‹ä»¶ç®¡ç†ç±»**ï¼š

```cpp
class EXTIObserver {
public:
    virtual void onInterrupt() = 0;
};

class EXTIManager {
private:
    static EXTIObserver* observers[16];
public:
    static void attach(uint8_t line, EXTIObserver* obs) {
        observers[line] = obs;
    }
    static void handle(uint8_t line) {
        if (observers[line]) observers[line]->onInterrupt();
    }
};

EXTIObserver* EXTIManager::observers[16] = {nullptr};
```

ç„¶åè®©ä½ çš„ `Key` ç±»ç»§æ‰¿å®ƒï¼š

```cpp
class Key : public EXTIObserver {
private:
    uint8_t line;
public:
    Key(uint8_t _line) : line(_line) {}
    void init() {
        EXTIManager::attach(line, this);
    }
    void onInterrupt() override {
        delay_ms(10);
        if (CHECK_KEY0 == 0) LEDStaticBuilder::led0_on();
    }
};
```

ä¸­æ–­å‡½æ•°ä¾ç„¶ç®€æ´ï¼š

```cpp
void EXTI4_IRQHandler(void){
    if (EXTI_GetITStatus(EXTI_Line4) == SET){
        EXTIManager::handle(4);
        EXTI_ClearITPendingBit(EXTI_Line4);
    }
}
```

---

## ğŸ¯ äº”ã€æ€»ç»“ï¼šæ¨èä½ é‡‡ç”¨çš„ç»“æ„

| æ¨¡å—                  | ç±»å‹  | åŠŸèƒ½          | è¯´æ˜       |
| ------------------- | --- | ----------- | -------- |
| `LEDStaticBuilder`  | é™æ€ç±» | æ§åˆ¶è¾“å‡º        | âœ… å·²å¾ˆå¥½    |
| `BEEPStaticBuilder` | é™æ€ç±» | æ§åˆ¶èœ‚é¸£å™¨       | âœ… å·²å¾ˆå¥½    |
| `EXTIManager`       | é™æ€ç±» | ç®¡ç†ä¸­æ–­çº¿ä¸å›è°ƒ    | âœ… æ¨èæ–°å»º   |
| `KEY`               | æ™®é€šç±» | å°è£…è¾“å…¥å¼•è„šä¸ä¸­æ–­è¡Œä¸º | âœ… æ³¨å†Œå›è°ƒå³å¯ |

---

æˆ‘å¯ä»¥å¸®ä½ æŠŠè¿™ä¸€æ•´å¥—ï¼ˆ`EXTIManager + Keyç±»`ï¼‰å†™æˆå’Œä½ ç°æœ‰ä»£ç é£æ ¼ä¸€è‡´çš„ `.hpp + .cpp` å®ç°ï¼Œè®©å®ƒç›´æ¥å¯ç”¨ã€‚
æ˜¯å¦è¦æˆ‘ç»™ä½ å®Œæ•´ç‰ˆæœ¬ï¼ˆå…¼å®¹ä½ çš„ `delay_ms`ã€`LEDStaticBuilder`ï¼‰ï¼Ÿ
